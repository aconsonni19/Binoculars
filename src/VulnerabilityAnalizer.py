import angr
import claripy

class VulnerabilityAnalyzer:
    def __init__(self, binary_path: str):
        # Tag for debugging purposes
        self.TAG = "[VulnerabilityAnalyzer]: "
        # Initialize the angr project without external libraries
        self.project = angr.Project(binary_path, auto_load_libs=False)
        # Initialize th CFG
        self.CFG = self.project.analyses.CFGFast(fail_fast=True)
        
    
    def __determine_instruction_pointer(self, state: angr.SimState):
        # Get the instruction pointer for the current architecture
        ip_offset = self.project.arch.ip_offset
        
        ip_name = self.project.arch.register_names[ip_offset]
                
        match ip_name:
            case "eip":
                ip = state.regs.eip # X86
            case "rip":
                ip = state.regs.rip # X86-64
        return ip
    
    
    def __is_pc_hyjacked(self, state: angr.SimState):
        # Get the instruction pointer register of the current state
        ip = self.__determine_instruction_pointer(state)
        if ip.symbolic:
            print(self.TAG + "Found symbolic program counter!")
            state.add_constraints(ip == 0x41414141) # AAAA
            if state.satisfiable():
                print(self.TAG + "FOUND USER INPUT CONTROLLABLE PROGRAM COUNTER! POSSIBLE BUFFER OVERFLOW!")
                return True
            else:
                return False
        else:
            return False        

        
    def analyze_buffer_overflows(self, input_bits: int):
        # Create a symbolic input of byte lenght input_len:
        sym_input = claripy.BVS("sym_input", input_bits * 8)
        # Get a state from the entry point of the program
        state = self.project.factory.entry_state(stdin = sym_input)
        # Get a simulation manager:
        simgr = self.project.factory.simulation_manager(save_unconstrained = True)
            
        # Check for PC controllable by user input:
        simgr.explore(find = self.__is_pc_hyjacked)
        
        for s in simgr.unconstrained:
            self.__is_pc_hyjacked(s)
        
                
        
        
        #if simgr.unconstrained:
        #    for s in simgr.unconstrained:
        #        s.add_constraints(s.regs.pc == b"AAA") 
        #       if(s.satisfiable()):
        #            print("Controllable program counter!, Potential buffer overflow detected!")
        

# Esegui l'analisi
v = VulnerabilityAnalyzer("/home/spitfire/Scrivania/University/Tesi/Binoculars/flaskr/tmp/primality_test")
v.analyze_buffer_overflows(20)
